<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“¡ Phone Drone Telemetry</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
    }
    .status {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .status-item:last-child {
      border-bottom: none;
    }
    .status-label {
      font-weight: 600;
      opacity: 0.9;
    }
    .status-value {
      font-weight: 700;
      font-size: 18px;
    }
    .connection-status {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .connected {
      background: rgba(76, 175, 80, 0.3);
      border: 2px solid #4caf50;
    }
    .disconnected {
      background: rgba(244, 67, 54, 0.3);
      border: 2px solid #f44336;
    }
    .battery-bar {
      width: 100%;
      height: 30px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      overflow: hidden;
      margin-top: 10px;
      position: relative;
    }
    .battery-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 14px;
    }
    .battery-low {
      background: linear-gradient(90deg, #f44336, #ff9800);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¡ Drone Telemetry System</h1>
    
    <div id="connectionStatus" class="connection-status disconnected">
      ğŸ”´ BaÄŸlantÄ± Bekleniyor...
    </div>

    <div class="status">
      <div class="status-item">
        <span class="status-label">ğŸ“ Konum</span>
        <span class="status-value" id="location">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">âš¡ HÄ±z (HesaplanmÄ±ÅŸ)</span>
        <span class="status-value" id="speed">0 km/h</span>
      </div>
      <div class="status-item" id="speedInfo" style="font-size: 12px; opacity: 0.7; padding-top: 5px;">
        <span>ğŸ’¡ Ä°lk veri iÃ§in telefonu en az 5-10 metre hareket ettirin</span>
      </div>
      <div class="status-item">
        <span class="status-label">â¬†ï¸ Ä°rtifa (Mutlak)</span>
        <span class="status-value" id="absoluteAltitude">- m</span>
      </div>
      <div class="status-item">
        <span class="status-label">ğŸ“Š Ä°rtifa (BaÄŸÄ±l)</span>
        <span class="status-value" id="relativeAltitude">0 m</span>
      </div>
      <div class="status-item" id="altitudeInfo" style="font-size: 12px; opacity: 0.7; padding-top: 5px;">
        <span>ğŸ’¡ Ä°rtifa hesaplanÄ±yor...</span>
      </div>
      <div class="status-item">
        <span class="status-label">ğŸ§­ YÃ¶n (Heading)</span>
        <span class="status-value" id="heading">-Â°</span>
      </div>
      <div class="status-item">
        <span class="status-label">ğŸ”‹ Batarya</span>
        <span class="status-value" id="battery">-</span>
      </div>
      <div class="battery-bar">
        <div class="battery-fill" id="batteryFill" style="width: 0%">0%</div>
      </div>
    </div>

    <!-- Debug Bilgileri -->
    <div class="status" style="margin-top: 20px; background: rgba(0, 0, 0, 0.2);">
      <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;">ğŸ” Debug Bilgileri</div>
      <div class="status-item">
        <span class="status-label">Raw Altitude (Cihazdan)</span>
        <span class="status-value" id="rawAltitude">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">Raw Speed (Cihazdan)</span>
        <span class="status-value" id="rawSpeed">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">Home Altitude</span>
        <span class="status-value" id="homeAltitude">-</span>
      </div>
      <div class="status-item" id="homePointInfo" style="font-size: 12px; opacity: 0.7; padding-top: 5px;">
        <span>ğŸ“ Home point koordinatlarÄ± yÃ¼kleniyor...</span>
      </div>
      <div class="status-item">
        <span class="status-label">GPS GÃ¼ncellemeleri</span>
        <span class="status-value" id="updateCount">0</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";

    // Socket.IO baÄŸlantÄ±sÄ±
    const socket = io("/", { transports: ["websocket"] });
    const droneId = "phone-" + Date.now(); // Unique drone ID

    // UI elementleri
    const connectionStatus = document.getElementById("connectionStatus");
    const locationEl = document.getElementById("location");
    const speedEl = document.getElementById("speed");
    const absoluteAltitudeEl = document.getElementById("absoluteAltitude");
    const relativeAltitudeEl = document.getElementById("relativeAltitude");
    const headingEl = document.getElementById("heading");
    const batteryEl = document.getElementById("battery");
    const batteryFill = document.getElementById("batteryFill");
    const rawAltitudeEl = document.getElementById("rawAltitude");
    const rawSpeedEl = document.getElementById("rawSpeed");
    const homeAltitudeEl = document.getElementById("homeAltitude");
    const updateCountEl = document.getElementById("updateCount");
    const speedInfoEl = document.getElementById("speedInfo");
    const altitudeInfoEl = document.getElementById("altitudeInfo");
    const homePointInfoEl = document.getElementById("homePointInfo");

    let updateCount = 0;

    // BaÄŸlantÄ± durumu
    socket.on("connect", () => {
      console.log("âœ… Socket baÄŸlÄ±:", socket.id);
      connectionStatus.textContent = "ğŸŸ¢ BaÄŸlÄ±: " + socket.id;
      connectionStatus.className = "connection-status connected";
    });

    socket.on("disconnect", () => {
      console.log("âŒ Socket baÄŸlantÄ±sÄ± kesildi");
      connectionStatus.textContent = "ğŸ”´ BaÄŸlantÄ± Kesildi";
      connectionStatus.className = "connection-status disconnected";
    });

    // Backend'den gelen hesaplanmÄ±ÅŸ telemetri verilerini dinle
    socket.on("telemetry_update", (data) => {
      updateCount++;
      console.log("ğŸ“Š Telemetry Update #" + updateCount + ":", data);
      
      // Konum
      locationEl.textContent = `${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;
      
      // HÄ±z (hesaplanmÄ±ÅŸ)
      const calculatedSpeed = data.calculatedSpeed || 0;
      speedEl.textContent = `${calculatedSpeed} km/h`;
      
      // HÄ±z bilgilendirmesi
      if (calculatedSpeed === 0 && updateCount > 1) {
        speedInfoEl.innerHTML = '<span style="color: #ff9800;">âš ï¸ Hareket edin! HÄ±z hesaplanmasÄ± iÃ§in en az 5-10 metre hareket gerekli.</span>';
      } else if (calculatedSpeed > 0) {
        speedInfoEl.innerHTML = '<span style="color: #4caf50;">âœ… HÄ±z baÅŸarÄ±yla hesaplandÄ±</span>';
      } else {
        speedInfoEl.innerHTML = '<span>ğŸ’¡ Ä°lk veri iÃ§in telefonu hareket ettirin</span>';
      }
      
      // Ä°rtifa (mutlak)
      const absoluteAlt = data.absoluteAltitude !== undefined ? data.absoluteAltitude : (data.altitude || 0);
      absoluteAltitudeEl.textContent = `${absoluteAlt.toFixed(1)} m`;
      
      // Ä°rtifa (baÄŸÄ±l - home'a gÃ¶re)
      const relativeAlt = data.relativeAltitude !== undefined ? data.relativeAltitude : 0;
      relativeAltitudeEl.textContent = `${relativeAlt.toFixed(1)} m`;
      
      // Home altitude bilgisi
      if (data.homeAltitude !== undefined) {
        homeAltitudeEl.textContent = `${data.homeAltitude.toFixed(1)} m`;
        
        // Ä°rtifa kaynaÄŸÄ±nÄ± belirle
        if (data.altitude !== null && data.altitude !== undefined) {
          altitudeInfoEl.innerHTML = `<span style="color: #4caf50;">âœ… Home point: ${data.homeAltitude.toFixed(1)} m (Cihazdan alÄ±ndÄ±)</span>`;
        } else {
          altitudeInfoEl.innerHTML = `<span style="color: #2196f3;">ğŸŒ Home point: ${data.homeAltitude.toFixed(1)} m (GPS API'den hesaplandÄ±)</span>`;
        }
      }

      // Home point koordinatlarÄ±
      if (data.homeLatitude !== undefined && data.homeLongitude !== undefined) {
        homePointInfoEl.innerHTML = `<span style="color: #4caf50;">ğŸ  Home Point: ${data.homeLatitude.toFixed(5)}, ${data.homeLongitude.toFixed(5)}</span>`;
      } else {
        homePointInfoEl.innerHTML = `<span>ğŸ“ Home point: Ä°lk konumunuz referans noktasÄ± olarak belirlendi</span>`;
      }
      
      // Raw altitude (cihazdan gelen)
      if (data.altitude !== null && data.altitude !== undefined) {
        rawAltitudeEl.textContent = `${data.altitude.toFixed(1)} m (cihazdan)`;
      } else {
        rawAltitudeEl.textContent = "null (GPS API kullanÄ±lÄ±yor)";
      }
      
      // Raw speed (cihazdan gelen, m/s)
      if (data.speed !== undefined) {
        rawSpeedEl.textContent = `${data.speed.toFixed(2)} m/s (${(data.speed * 3.6).toFixed(2)} km/h)`;
      } else {
        rawSpeedEl.textContent = "-";
      }
      
      // Heading (yÃ¶n)
      const heading = data.heading || 0;
      headingEl.textContent = `${heading.toFixed(0)}Â°`;
      
      // Batarya
      const batteryPercent = (data.battery * 100).toFixed(0);
      batteryEl.textContent = `${batteryPercent}%`;
      batteryFill.style.width = `${data.battery * 100}%`;
      batteryFill.textContent = `${batteryPercent}%`;
      
      // Batarya dÃ¼ÅŸÃ¼kse kÄ±rmÄ±zÄ± gÃ¶ster
      if (data.battery < 0.2) {
        batteryFill.classList.add("battery-low");
      } else {
        batteryFill.classList.remove("battery-low");
      }
      
      // GÃ¼ncelleme sayÄ±sÄ±
      updateCountEl.textContent = updateCount;
    });

    // GPS konum takibi
    let watchId = null;

    // Batarya API'si (destekleniyorsa)
    async function getBatteryLevel() {
      try {
        if ('getBattery' in navigator) {
          const battery = await navigator.getBattery();
          return battery.level;
        }
        // Fallback: SimÃ¼le edilmiÅŸ batarya (gerÃ§ek uygulamada sensÃ¶rden gelir)
        return 0.75;
      } catch (e) {
        console.warn("Battery API desteklenmiyor, varsayÄ±lan deÄŸer kullanÄ±lÄ±yor");
        return 0.75;
      }
    }

    // GPS izleme baÅŸlat
    function startTracking() {
      if (!navigator.geolocation) {
        alert("GPS desteklenmiyor!");
        return;
      }

      watchId = navigator.geolocation.watchPosition(
        async (position) => {
          const { latitude, longitude, altitude, speed, heading, accuracy } = position.coords;
          const timestamp = position.timestamp || Date.now();
          
          // Batarya seviyesini al
          const battery = await getBatteryLevel();

          // Telemetri verisini backend'e gÃ¶nder
          socket.emit("telemetry", {
            droneId,
            latitude,
            longitude,
            altitude: altitude !== null && altitude !== undefined ? altitude : null, // null gÃ¶nder, backend hesaplasÄ±n
            speed: speed !== null && speed !== undefined ? speed : 0, // m/s (raw)
            heading: heading !== null && heading !== undefined ? heading : 0,
            battery: battery,
            timestamp: timestamp
          });

          console.log("ğŸ“¤ Telemetry gÃ¶nderildi #" + (updateCount + 1) + ":", {
            latitude: latitude.toFixed(6),
            longitude: longitude.toFixed(6),
            altitude: altitude !== null ? altitude.toFixed(1) + " m" : "null",
            speed: speed !== null ? (speed * 3.6).toFixed(2) + " km/h" : "0",
            heading: heading !== null ? heading.toFixed(0) + "Â°" : "0Â°",
            battery: (battery * 100).toFixed(0) + "%"
          });
        },
        (error) => {
          console.error("âŒ GPS hata:", error);
          alert(`GPS HatasÄ±: ${error.message}`);
        },
        {
          enableHighAccuracy: true, // YÃ¼ksek doÄŸruluk iÃ§in
          maximumAge: 1000, // 1 saniye Ã¶nceki veriyi kabul et
          timeout: 10000 // 10 saniye timeout
        }
      );
    }

    // Sayfa yÃ¼klendiÄŸinde izlemeyi baÅŸlat
    startTracking();

    // Sayfa kapanÄ±rken izlemeyi durdur
    window.addEventListener("beforeunload", () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
      socket.disconnect();
    });
  </script>
</body>
</html>
